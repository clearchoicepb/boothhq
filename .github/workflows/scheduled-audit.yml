name: Scheduled Codebase Audit

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC (midnight MST)
  workflow_dispatch:
    inputs:
      audit_type:
        description: 'Type of audit to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - typescript-only
          - security-only

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Claude Code Audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--max-turns 50"
          prompt: |
            Run an AUTONOMOUS AUDIT of this codebase. DO NOT modify any files.

            ## Tasks:
            1. Run: npx tsc --noEmit (capture all TypeScript errors)
            2. Run: npm run lint (capture all lint issues)
            3. Find files over 400 lines that need refactoring
            4. Count 'any' types and console.log statements
            5. Search for 'department' vs 'departments' column mismatches
            6. List all TODO/FIXME comments
            7. Check for potential security issues (exposed secrets, SQL injection)

            ## Output Format:

            ## üî¥ CRITICAL (X issues)
            [Runtime errors and security issues]

            ## üü† WARNINGS (X issues)
            [Technical debt]

            ## üü° SUGGESTIONS (X issues)
            [Code quality improvements]

            ## üìä METRICS
            - TypeScript errors: X
            - Lint warnings: X
            - Large files: X
            - 'any' types: X
            - Console.logs: X

            Include file paths and line numbers.

      - name: Create Issue with Results
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîç Automated Audit Report - ${date}`,
              body: `## Automated Codebase Audit\n\n**Run date:** ${date}\n**Triggered by:** ${context.eventName === 'schedule' ? 'Daily schedule' : 'Manual trigger'}\n\n---\n\nSee workflow run for details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['audit', 'automated']
            });
